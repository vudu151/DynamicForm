@page
@model DynamicForm.Web.Pages.Forms.DesignerModel
@using System.Text.Json
@using DynamicForm.Web.Models
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "Thiết kế Form";
    var fields = Model.Metadata?.Fields ?? new List<FormFieldInfo>();
    var apiBaseUrl = (Configuration["ApiSettings:BaseUrl"] ?? "https://localhost:7220").TrimEnd('/');
    var jsOptions = new JsonSerializerOptions(JsonSerializerDefaults.Web);
}

<div class="container-fluid mt-4">
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }
    @if (TempData["ErrorDetails"] != null)
    {
        <div class="alert alert-warning">
            <div class="fw-semibold mb-1">Chi tiết lỗi (debug)</div>
            <pre class="mb-0" style="white-space:pre-wrap;">@TempData["ErrorDetails"]</pre>
        </div>
        <script>
            console.error("Designer error details:\n" + @Html.Raw(JsonSerializer.Serialize(TempData["ErrorDetails"]?.ToString())));
        </script>
    }

    <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
            <h2 class="mb-0 d-flex align-items-center gap-2">
                Thiết kế Form
                <span id="dirtyBadge" class="badge bg-warning text-dark" style="display:none;">Chưa lưu</span>
            </h2>
            @if (Model.Metadata != null)
            {
                <div class="text-muted">
                    <span class="me-2"><strong>@Model.Metadata.Form.Name</strong> (@Model.Metadata.Form.Code)</span>
                    <span class="badge bg-primary">Version @Model.Metadata.Version.Version</span>
                </div>
            }
        </div>
        <div>
            <a class="btn btn-outline-secondary" href="/Forms">Danh sách Form</a>
            @if (Model.Metadata != null)
            {
                <form method="post" asp-page-handler="ActivateVersion" class="d-inline">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="Code" value="@Model.Metadata.Form.Code" />
                    <input type="hidden" name="ActivateVersionId" value="@Model.Metadata.Version.Id" />
                    <button type="submit" class="btn btn-outline-success ms-2">
                        Kích hoạt version này
                    </button>
                </form>
                <a class="btn btn-primary ms-2" href="/Forms/Fill?code=@Model.Metadata.Form.Code">Xem / Điền Form</a>
            }
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Chọn Form</label>
                    <select class="form-select" id="formSelect">
                        <option value="">-- Chọn --</option>
                        @foreach (var f in Model.Forms.OrderBy(x => x.Name))
                        {
                            <option value="@f.Code" data-form-id="@f.Id" selected="@(string.Equals(Model.Code, f.Code, StringComparison.OrdinalIgnoreCase))">
                                @f.Name (@f.Code)
                            </option>
                        }
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Chọn Version</label>
                    <select class="form-select" id="versionSelect" @(Model.Versions.Any() ? "" : "disabled")>
                        <option value="">-- Chọn --</option>
                        @foreach (var v in Model.Versions.OrderByDescending(x => x.CreatedDate))
                        {
                            <option value="@v.Id" selected="@(Model.VersionId == v.Id)">
                                @v.Version @(v.IsActive ? "(Active)" : "")
                            </option>
                        }
                    </select>
                </div>
            </div>

            <hr class="my-3" />

            <details>
                <summary class="mb-2"><strong>Tạo form mới</strong></summary>
                <form method="post" asp-page-handler="CreateForm" class="mt-3">
                    @Html.AntiForgeryToken()
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label">Code</label>
                            <input class="form-control" name="NewFormCode" placeholder="VD: PHIEU_KHAM" required />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Name</label>
                            <input class="form-control" name="NewFormName" placeholder="VD: Phiếu Khám Bệnh" required />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Version</label>
                            <input class="form-control" name="NewVersion" placeholder="VD: 1.0.0" required />
                        </div>
                        <div class="col-md-2 d-grid">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-success" type="submit">Tạo</button>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <input class="form-control" name="NewFormDescription" placeholder="Mô tả form (tuỳ chọn)" />
                        </div>
                    </div>
                </form>
            </details>
        </div>
    </div>

    @if (Model.Metadata == null)
    {
        <div class="alert alert-info">
            Chọn form + version để bắt đầu thiết kế.
        </div>
    }
    else
    {
        <form method="post" asp-page-handler="Save" id="saveForm">
            @Html.AntiForgeryToken()
            <input type="hidden" name="Code" value="@Model.Metadata.Form.Code" />
            <input type="hidden" name="VersionIdPost" value="@Model.Metadata.Version.Id" />
            <input type="hidden" name="FieldsJson" id="fieldsJson" />

            <div class="row g-3">
                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>Toolbox</strong>
                        </div>
                        <div class="card-body border-bottom">
                            <input class="form-control form-control-sm" id="toolboxSearch" placeholder="Tìm loại câu hỏi..." />
                        </div>
                        <div class="list-group list-group-flush" id="toolbox">
                            <button class="list-group-item list-group-item-action" type="button" data-type="1">Text</button>
                            <button class="list-group-item list-group-item-action" type="button" data-type="2">Number</button>
                            <button class="list-group-item list-group-item-action" type="button" data-type="3">Date</button>
                            <button class="list-group-item list-group-item-action" type="button" data-type="6">Select</button>
                            <button class="list-group-item list-group-item-action" type="button" data-type="10">TextArea</button>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">
                                Tip: click để thêm. Có thể kéo-thả để sắp xếp.
                            </small>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <strong>Preview</strong>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMoveUp" disabled>↑</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnMoveDown" disabled>↓</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDuplicate" disabled>Duplicate</button>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="btnDelete" disabled>Xóa</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="previewEmpty" class="text-muted" style="display:none;">
                                Chưa có câu hỏi nào. Chọn 1 loại ở Toolbox để thêm.
                            </div>
                            <div class="list-group" id="fieldsList"></div>
                            <div class="mt-3 text-muted small">
                                Kéo-thả để sắp xếp. Click 1 field để chỉnh bên phải.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3">
                    <div class="card h-100">
                        <div class="card-header">
                            <strong>Properties</strong>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Change log</label>
                                <input class="form-control" name="ChangeLog" value="@Model.ChangeLog" placeholder="Mô tả thay đổi của version" />
                            </div>

                            <hr />

                            <div id="propsDisabled" class="text-muted">
                                Chọn 1 field trong Preview để chỉnh.
                            </div>

                            <div id="propsPanel" style="display:none;">
                                <div class="mb-2">
                                    <label class="form-label">Field type</label>
                                    <select class="form-select" id="propFieldType">
                                        <option value="1">Text</option>
                                        <option value="2">Number</option>
                                        <option value="3">Date</option>
                                        <option value="6">Select</option>
                                        <option value="10">TextArea</option>
                                    </select>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Field code</label>
                                    <input class="form-control" id="propFieldCode" />
                                    <div class="form-text">Dùng để map dữ liệu (ví dụ: HO_TEN, TUOI, ...)</div>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Label</label>
                                    <input class="form-control" id="propLabel" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Placeholder</label>
                                    <input class="form-control" id="propPlaceholder" />
                                </div>
                                <div class="mb-2">
                                    <label class="form-label">Help text</label>
                                    <input class="form-control" id="propHelpText" />
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="propRequired" />
                                            <label class="form-check-label" for="propRequired">Required</label>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="form-check mt-2">
                                            <input class="form-check-input" type="checkbox" id="propVisible" />
                                            <label class="form-check-label" for="propVisible">Visible</label>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-2">
                                    <label class="form-label">Col span (layout)</label>
                                    <select class="form-select" id="propColSpan">
                                        <option value="12">12/12 (col-md-12)</option>
                                        <option value="11">11/12 (col-md-11)</option>
                                        <option value="10">10/12 (col-md-10)</option>
                                        <option value="9">9/12 (col-md-9)</option>
                                        <option value="8">8/12 (col-md-8)</option>
                                        <option value="7">7/12 (col-md-7)</option>
                                        <option value="6">6/12 (col-md-6)</option>
                                        <option value="5">5/12 (col-md-5)</option>
                                        <option value="4">4/12 (col-md-4)</option>
                                        <option value="3">3/12 (col-md-3)</option>
                                        <option value="2">2/12 (col-md-2)</option>
                                        <option value="1">1/12 (col-md-1)</option>
                                    </select>
                                    <div class="form-text">Lưu trong PropertiesJson: {"colSpan":...}</div>
                                </div>

                                <div id="selectOptionsBox" style="display:none;">
                                    <hr />
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <strong>Options</strong>
                                        <button class="btn btn-sm btn-outline-primary" type="button" id="btnAddOption">+ Option</button>
                                    </div>
                                    <div id="optionsList" class="vstack gap-2"></div>
                                    <div class="form-text">Select sẽ dùng options này khi render.</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white">
                            <div id="designerErrors" class="alert alert-warning py-2 small mb-2" style="display:none;"></div>
                            <button type="button" class="btn btn-success w-100" id="btnSave">Lưu thiết kế</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>

        <script>
            const API_BASE_URL = @Html.Raw(JsonSerializer.Serialize(apiBaseUrl, jsOptions));
            // IMPORTANT: serialize to camelCase for JS (fieldCode/fieldType/label...)
            const initialFields = @Html.Raw(JsonSerializer.Serialize(fields, jsOptions));
        </script>
        <script>
            const state = {
                fields: Array.isArray(initialFields) ? initialFields : [],
                selectedIndex: -1,
                dirty: false,
                draggingIndex: null,
                isSubmitting: false
            };

            const el = (id) => document.getElementById(id);

            function typeLabel(t) {
                switch (Number(t)) {
                    case 1: return "Text";
                    case 2: return "Number";
                    case 3: return "Date";
                    case 6: return "Select";
                    case 10: return "TextArea";
                    default: return `Type ${t}`;
                }
            }

            function ensureArray(x) { return Array.isArray(x) ? x : []; }

            function setDirty(isDirty) {
                state.dirty = !!isDirty;
                el("dirtyBadge").style.display = state.dirty ? "inline-block" : "none";
            }

            function normalizeCode(code) {
                return String(code || "").trim().toUpperCase();
            }

            function labelToCode(label) {
                const raw = String(label || "")
                    .trim()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, ""); // strip diacritics

                let code = raw
                    .replace(/[^a-zA-Z0-9]+/g, "_")
                    .replace(/^_+|_+$/g, "")
                    .toUpperCase();

                if (!code) code = "FIELD";
                if (/^[0-9]/.test(code)) code = "F_" + code;
                return code;
            }

            function validateAll() {
                const errors = [];
                const seen = new Map();

                state.fields.forEach((f, idx) => {
                    const c = normalizeCode(f.fieldCode);
                    if (!c) {
                        errors.push(`Field #${idx + 1}: FieldCode không được để trống`);
                        return;
                    }
                    if (!/^[A-Z0-9_]+$/.test(c)) {
                        errors.push(`Field #${idx + 1}: FieldCode chỉ nên dùng A-Z, 0-9 và _`);
                    }
                    if (seen.has(c)) {
                        errors.push(`Trùng FieldCode: ${c} (fields #${seen.get(c) + 1} và #${idx + 1})`);
                    } else {
                        seen.set(c, idx);
                    }
                });

                return errors;
            }

            function renderErrors() {
                const errs = validateAll();
                const box = el("designerErrors");
                if (errs.length === 0) {
                    box.style.display = "none";
                    box.innerHTML = "";
                    el("btnSave").disabled = false;
                    return;
                }
                box.style.display = "block";
                box.innerHTML = `<div class="fw-semibold mb-1">Cần sửa trước khi lưu:</div><ul class="mb-0 ps-3">${errs.map(e => `<li>${escapeHtml(e)}</li>`).join("")}</ul>`;
                el("btnSave").disabled = true;
            }

            function nextFieldCode() {
                const existing = new Set(state.fields.map(f => (f.fieldCode || "").toUpperCase()));
                let i = state.fields.length + 1;
                while (true) {
                    const code = `FIELD_${String(i).padStart(3, "0")}`;
                    if (!existing.has(code)) return code;
                    i++;
                }
            }

            function normalizeOrders() {
                state.fields.forEach((f, idx) => {
                    f.displayOrder = idx + 1;
                    f.options = ensureArray(f.options);
                    f.validations = ensureArray(f.validations);
                    f.conditions = ensureArray(f.conditions);
                    f.options.forEach((o, oidx) => {
                        o.displayOrder = oidx + 1;
                    });
                });
            }

            function parsePropsJson(field) {
                const raw = field.propertiesJson;
                if (!raw) return {};
                try { return JSON.parse(raw); } catch { return {}; }
            }

            function setColSpan(field, colSpan) {
                const props = parsePropsJson(field);
                const n = Number(colSpan);
                const safe = Number.isFinite(n) ? Math.min(12, Math.max(1, Math.trunc(n))) : 6;
                props.colSpan = safe;
                field.propertiesJson = JSON.stringify(props);
            }

            function getColSpan(field) {
                const props = parsePropsJson(field);
                const cs = Number(props.colSpan || 6);
                if (!Number.isFinite(cs)) return 6;
                return Math.min(12, Math.max(1, Math.trunc(cs)));
            }

            function renderPreview() {
                const list = el("fieldsList");
                list.innerHTML = "";

                el("previewEmpty").style.display = state.fields.length === 0 ? "block" : "none";

                state.fields.forEach((f, idx) => {
                    const item = document.createElement("div");
                    item.className = "list-group-item df-field-item";
                    item.setAttribute("draggable", "true");
                    item.dataset.idx = String(idx);
                    if (idx === state.selectedIndex) item.classList.add("active");
                    if (f.isVisible === false) item.classList.add("df-field-hidden");

                    const required = f.isRequired ? "<span class='text-danger ms-1'>*</span>" : "";
                    const code = f.fieldCode ? `<span class="text-muted">• ${escapeHtml(f.fieldCode)}</span>` : "";
                    const preview = renderFieldPreviewHtml(f);

                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start gap-2">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center gap-2">
                                    <span class="df-drag-handle text-muted" title="Kéo để sắp xếp">≡</span>
                                    <div class="fw-semibold">${escapeHtml(f.label || "(no label)")}${required}</div>
                                </div>
                                <div class="small opacity-75">${typeLabel(f.fieldType)} ${code}</div>
                                <div class="mt-2 df-preview-control">${preview}</div>
                            </div>
                            <span class="badge bg-light text-dark">${idx + 1}</span>
                        </div>
                    `;

                    item.addEventListener("click", (e) => {
                        // Avoid interfering with drag
                        if (e.target && e.target.closest && e.target.closest(".df-drag-handle")) return;
                        selectField(idx);
                    });
                    list.appendChild(item);
                });

                const hasSel = state.selectedIndex >= 0 && state.selectedIndex < state.fields.length;
                el("btnMoveUp").disabled = !hasSel || state.selectedIndex === 0;
                el("btnMoveDown").disabled = !hasSel || state.selectedIndex === state.fields.length - 1;
                el("btnDuplicate").disabled = !hasSel;
                el("btnDelete").disabled = !hasSel;

                renderErrors();
            }

            function renderFieldPreviewHtml(f) {
                const ph = escapeHtml(f.placeholder || "");
                switch (Number(f.fieldType)) {
                    case 1:
                        return `<input class="form-control form-control-sm" type="text" placeholder="${ph}" disabled>`;
                    case 2:
                        return `<input class="form-control form-control-sm" type="number" placeholder="${ph}" disabled>`;
                    case 3:
                        return `<input class="form-control form-control-sm" type="date" disabled>`;
                    case 6: {
                        const opts = ensureArray(f.options)
                            .sort((a, b) => (Number(a.displayOrder || 0) - Number(b.displayOrder || 0)))
                            .slice(0, 6);
                        const html = opts.map(o => `<option>${escapeHtml(o.label || o.value || "")}</option>`).join("");
                        return `<select class="form-select form-select-sm" disabled><option>-- Chọn --</option>${html}</select>`;
                    }
                    case 10:
                        return `<textarea class="form-control form-control-sm" rows="2" placeholder="${ph}" disabled></textarea>`;
                    default:
                        return `<input class="form-control form-control-sm" type="text" placeholder="${ph}" disabled>`;
                }
            }

            function escapeHtml(s) {
                return String(s)
                    .replaceAll("&", "&amp;")
                    .replaceAll("<", "&lt;")
                    .replaceAll(">", "&gt;")
                    .replaceAll("\"", "&quot;")
                    .replaceAll("'", "&#39;");
            }

            function selectField(idx) {
                state.selectedIndex = idx;
                renderPreview();
                renderProperties();
                // focus label for faster editing
                setTimeout(() => {
                    const input = el("propLabel");
                    if (input) input.focus();
                }, 0);
            }

            function renderProperties() {
                const hasSel = state.selectedIndex >= 0 && state.selectedIndex < state.fields.length;
                el("propsDisabled").style.display = hasSel ? "none" : "block";
                el("propsPanel").style.display = hasSel ? "block" : "none";
                if (!hasSel) return;

                const f = state.fields[state.selectedIndex];

                el("propFieldType").value = String(f.fieldType ?? 1);
                el("propFieldCode").value = f.fieldCode ?? "";
                el("propLabel").value = f.label ?? "";
                el("propPlaceholder").value = f.placeholder ?? "";
                el("propHelpText").value = f.helpText ?? "";
                el("propRequired").checked = !!f.isRequired;
                el("propVisible").checked = (f.isVisible !== false);
                el("propColSpan").value = String(getColSpan(f));

                const isSelect = Number(f.fieldType) === 6;
                el("selectOptionsBox").style.display = isSelect ? "block" : "none";
                if (isSelect) renderOptions();
            }

            function updateSelected(mutator) {
                const idx = state.selectedIndex;
                if (idx < 0 || idx >= state.fields.length) return;
                mutator(state.fields[idx]);
                setDirty(true);
                renderPreview();
                renderProperties();
            }

            function renderOptions() {
                const box = el("optionsList");
                box.innerHTML = "";
                const f = state.fields[state.selectedIndex];
                f.options = ensureArray(f.options);

                f.options.forEach((o, idx) => {
                    const row = document.createElement("div");
                    row.className = "border rounded p-2";

                    const isDefault = !!o.isDefault;
                    row.innerHTML = `
                        <div class="row g-2 align-items-end">
                            <div class="col-5">
                                <label class="form-label mb-1">Value</label>
                                <input class="form-control form-control-sm" data-k="value" value="${escapeHtml(o.value ?? "")}">
                            </div>
                            <div class="col-5">
                                <label class="form-label mb-1">Label</label>
                                <input class="form-control form-control-sm" data-k="label" value="${escapeHtml(o.label ?? "")}">
                            </div>
                            <div class="col-2">
                                <button class="btn btn-sm btn-outline-danger w-100" type="button" data-act="del">X</button>
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="defaultOpt" ${isDefault ? "checked" : ""} data-act="default">
                            <label class="form-check-label">Default</label>
                        </div>
                    `;

                    row.querySelectorAll("input[data-k]").forEach(inp => {
                        inp.addEventListener("input", (e) => {
                            const key = e.target.getAttribute("data-k");
                            o[key] = e.target.value;
                            setDirty(true);
                            renderErrors();
                        });
                    });
                    row.querySelector("[data-act='del']").addEventListener("click", () => {
                        f.options.splice(idx, 1);
                        setDirty(true);
                        renderOptions();
                        renderErrors();
                    });
                    row.querySelector("[data-act='default']").addEventListener("change", () => {
                        f.options.forEach(x => x.isDefault = false);
                        o.isDefault = true;
                        setDirty(true);
                    });

                    box.appendChild(row);
                });
            }

            function addField(fieldType) {
                normalizeOrders();
                const f = {
                    fieldCode: nextFieldCode(),
                    fieldType: Number(fieldType),
                    label: "Câu hỏi mới",
                    displayOrder: state.fields.length + 1,
                    isRequired: false,
                    isVisible: true,
                    defaultValue: null,
                    placeholder: null,
                    helpText: null,
                    cssClass: null,
                    propertiesJson: JSON.stringify({ colSpan: 6 }),
                    parentFieldId: null,
                    minOccurs: null,
                    maxOccurs: null,
                    validations: [],
                    conditions: [],
                    options: []
                };
                if (Number(fieldType) === 6) {
                    f.options = [
                        { value: "A", label: "Option A", isDefault: true, displayOrder: 1 },
                        { value: "B", label: "Option B", isDefault: false, displayOrder: 2 }
                    ];
                }
                state.fields.push(f);
                setDirty(true);
                selectField(state.fields.length - 1);
            }

            function moveSelected(delta) {
                const i = state.selectedIndex;
                if (i < 0) return;
                const j = i + delta;
                if (j < 0 || j >= state.fields.length) return;
                const tmp = state.fields[i];
                state.fields[i] = state.fields[j];
                state.fields[j] = tmp;
                state.selectedIndex = j;
                normalizeOrders();
                setDirty(true);
                renderPreview();
                renderProperties();
            }

            function duplicateSelected() {
                const i = state.selectedIndex;
                if (i < 0) return;
                const src = state.fields[i];
                const copy = JSON.parse(JSON.stringify(src));
                // New entity
                copy.id = "00000000-0000-0000-0000-000000000000";
                copy.fieldCode = nextFieldCode();
                copy.label = (src.label || "Câu hỏi") + " (copy)";
                if (Array.isArray(copy.options)) {
                    copy.options.forEach(o => o.id = "00000000-0000-0000-0000-000000000000");
                }
                if (Array.isArray(copy.validations)) {
                    copy.validations.forEach(v => v.id = "00000000-0000-0000-0000-000000000000");
                }
                if (Array.isArray(copy.conditions)) {
                    copy.conditions.forEach(c => c.id = "00000000-0000-0000-0000-000000000000");
                }
                state.fields.splice(i + 1, 0, copy);
                normalizeOrders();
                setDirty(true);
                selectField(i + 1);
            }

            function deleteSelected() {
                const i = state.selectedIndex;
                if (i < 0) return;
                state.fields.splice(i, 1);
                state.selectedIndex = Math.min(i, state.fields.length - 1);
                normalizeOrders();
                setDirty(true);
                renderPreview();
                renderProperties();
            }

            function wireDragDrop() {
                const list = el("fieldsList");

                list.addEventListener("dragstart", (e) => {
                    const item = e.target.closest(".df-field-item");
                    if (!item) return;
                    state.draggingIndex = Number(item.dataset.idx);
                    item.classList.add("df-dragging");
                    e.dataTransfer.effectAllowed = "move";
                });

                list.addEventListener("dragend", (e) => {
                    const item = e.target.closest(".df-field-item");
                    if (item) item.classList.remove("df-dragging");
                    state.draggingIndex = null;
                    document.querySelectorAll(".df-drop-target").forEach(x => x.classList.remove("df-drop-target"));
                });

                list.addEventListener("dragover", (e) => {
                    e.preventDefault();
                    const over = e.target.closest(".df-field-item");
                    if (!over) return;
                    over.classList.add("df-drop-target");
                });

                list.addEventListener("dragleave", (e) => {
                    const over = e.target.closest(".df-field-item");
                    if (!over) return;
                    over.classList.remove("df-drop-target");
                });

                list.addEventListener("drop", (e) => {
                    e.preventDefault();
                    const over = e.target.closest(".df-field-item");
                    if (!over) return;
                    const from = state.draggingIndex;
                    const to = Number(over.dataset.idx);
                    if (from == null || Number.isNaN(to) || from === to) return;

                    const moved = state.fields.splice(from, 1)[0];
                    state.fields.splice(to, 0, moved);
                    state.selectedIndex = to;
                    normalizeOrders();
                    setDirty(true);
                    renderPreview();
                    renderProperties();
                });
            }

            function wireEvents() {
                document.querySelectorAll("#toolbox [data-type]").forEach(btn => {
                    btn.addEventListener("click", () => addField(btn.getAttribute("data-type")));
                });

                el("propFieldType").addEventListener("change", (e) => {
                    updateSelected(f => {
                        f.fieldType = Number(e.target.value);
                        if (f.fieldType !== 6) f.options = [];
                        if (f.fieldType === 6 && (!f.options || f.options.length === 0)) {
                            f.options = [{ value: "A", label: "Option A", isDefault: true, displayOrder: 1 }];
                        }
                    });
                });
                el("propFieldCode").addEventListener("input", (e) => updateSelected(f => { f.fieldCode = e.target.value; f._codeTouched = true; }));
                el("propLabel").addEventListener("input", (e) => updateSelected(f => {
                    const newLabel = e.target.value;
                    f.label = newLabel;
                    // Auto-generate fieldCode only if user hasn't edited it manually
                    if (!f._codeTouched) {
                        const base = labelToCode(newLabel);
                        // Ensure uniqueness
                        let code = base;
                        const existing = new Set(state.fields.map(x => normalizeCode(x.fieldCode)));
                        existing.delete(normalizeCode(f.fieldCode)); // allow overwrite self
                        let n = 2;
                        while (existing.has(code)) {
                            code = `${base}_${n++}`;
                        }
                        f.fieldCode = code;
                    }
                }));
                el("propPlaceholder").addEventListener("input", (e) => updateSelected(f => f.placeholder = e.target.value));
                el("propHelpText").addEventListener("input", (e) => updateSelected(f => f.helpText = e.target.value));
                el("propRequired").addEventListener("change", (e) => updateSelected(f => f.isRequired = e.target.checked));
                el("propVisible").addEventListener("change", (e) => updateSelected(f => f.isVisible = e.target.checked));
                el("propColSpan").addEventListener("change", (e) => updateSelected(f => setColSpan(f, e.target.value)));

                el("btnAddOption").addEventListener("click", () => {
                    updateSelected(f => {
                        f.options = ensureArray(f.options);
                        f.options.push({ value: "", label: "", isDefault: f.options.length === 0, displayOrder: f.options.length + 1 });
                    });
                });

                el("btnMoveUp").addEventListener("click", () => moveSelected(-1));
                el("btnMoveDown").addEventListener("click", () => moveSelected(1));
                el("btnDuplicate").addEventListener("click", () => duplicateSelected());
                el("btnDelete").addEventListener("click", () => deleteSelected());

                el("btnSave").addEventListener("click", () => {
                    const errs = validateAll();
                    if (errs.length > 0) {
                        renderErrors();
                        return;
                    }
                    state.isSubmitting = true;
                    setDirty(false);
                    normalizeOrders();
                    el("fieldsJson").value = JSON.stringify(state.fields);
                    el("saveForm").submit();
                });

                el("toolboxSearch")?.addEventListener("input", (e) => {
                    const q = String(e.target.value || "").trim().toLowerCase();
                    document.querySelectorAll("#toolbox [data-type]").forEach(btn => {
                        const text = (btn.textContent || "").toLowerCase();
                        btn.style.display = !q || text.includes(q) ? "" : "none";
                    });
                });

                const formSelect = el("formSelect");
                const versionSelect = el("versionSelect");

                // UX: when user selects a form on the initial Designer page (no ?code=),
                // auto-load versions to enable version dropdown (instead of staying disabled).

                async function fetchJson(url) {
                    const res = await fetch(url, { headers: { "Accept": "application/json" } });
                    const text = await res.text();
                    if (!res.ok) throw new Error(`${res.status} ${res.statusText}\n${text}`);
                    return text ? JSON.parse(text) : null;
                }

                function navigateToDesigner(code, versionId) {
                    if (!code) return;
                    const url = versionId
                        ? `/Forms/Designer?code=${encodeURIComponent(code)}&versionId=${encodeURIComponent(versionId)}`
                        : `/Forms/Designer?code=${encodeURIComponent(code)}`;
                    window.location.href = url;
                }

                async function loadVersionsForSelectedForm() {
                    if (!formSelect || !versionSelect) return;
                    const code = formSelect.value;
                    const opt = formSelect.selectedOptions && formSelect.selectedOptions[0];
                    const formId = opt?.dataset?.formId;

                    if (!code || !formId) {
                        versionSelect.innerHTML = `<option value="">-- Chọn --</option>`;
                        versionSelect.disabled = true;
                        return;
                    }

                    versionSelect.disabled = true;
                    versionSelect.innerHTML = `<option value="">Đang tải version...</option>`;

                    try {
                        const versions = await fetchJson(`${API_BASE_URL}/api/forms/${encodeURIComponent(formId)}/versions`) || [];
                        versions.sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));

                        const optionsHtml = [`<option value="">-- Chọn --</option>`]
                            .concat(versions.map(v => {
                                const label = `${v.version}${v.isActive ? " (Active)" : ""}`;
                                return `<option value="${v.id}">${escapeHtml(label)}</option>`;
                            }))
                            .join("");

                        versionSelect.innerHTML = optionsHtml;

                        // Preselect active, otherwise latest
                        const active = versions.find(v => v.isActive);
                        if (active?.id) versionSelect.value = active.id;
                        else if (versions[0]?.id) versionSelect.value = versions[0].id;

                        versionSelect.disabled = versions.length === 0;

                        // Auto-load the selected form/version (removes need for "Tải Form" button)
                        if (!versionSelect.disabled && versionSelect.value) {
                            navigateToDesigner(code, versionSelect.value);
                        } else {
                            navigateToDesigner(code, null);
                        }
                    } catch (e) {
                        console.error("Failed to load versions", e);
                        versionSelect.innerHTML = `<option value="">Lỗi tải version (xem Console)</option>`;
                        versionSelect.disabled = true;
                    }
                }

                // If server didn't load versions (disabled), try client-side loading after selecting a form.
                formSelect?.addEventListener("change", () => loadVersionsForSelectedForm());
                versionSelect?.addEventListener("change", () => {
                    const code = formSelect?.value;
                    const vid = versionSelect?.value;
                    if (!code) return;
                    // If user clears version selection, still load form by code (server picks latest/active)
                    navigateToDesigner(code, vid || null);
                });
                if (versionSelect?.disabled) {
                    // Handle cases where browser auto-fills a selection but server didn't load versions
                    loadVersionsForSelectedForm();
                }

                // Prevent "Leave site?" popup when user explicitly submits a form (Save / Activate / Create...)
                document.querySelectorAll("form").forEach(f => {
                    f.addEventListener("submit", () => {
                        state.isSubmitting = true;
                        setDirty(false);
                    });
                });

                window.addEventListener("beforeunload", (e) => {
                    if (!state.dirty || state.isSubmitting) return;
                    e.preventDefault();
                    e.returnValue = "";
                });
            }

            normalizeOrders();
            wireEvents();
            wireDragDrop();
            renderPreview();
            renderProperties();
        </script>
    }
</div>

